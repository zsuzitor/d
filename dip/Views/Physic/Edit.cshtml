


@model dip.Models.ViewModel.PhysicV.EditV

@{
    ViewBag.Title = "Edit";
}

<script>
    var num_delete_img = 0;


    $(document).ready(function () {
        let countPhaseBegin=@Model.CountPhaseBegin;
        let countPhaseEnd=@Model.CountPhaseEnd;
    
        for(let i=0;i<countPhaseBegin;++i)
            document.getElementById('PhaseObject_all_S_'+i).style.display='block';
        for(let i=0;i<countPhaseEnd;++i)
            document.getElementById('PhaseObject_all_E_'+i).style.display='block';
        
    });


    function delete_img(but) {
        var id=but.id.split("_")[1];
        var div = document.getElementById("div_delete_img_id");
        var str = "<input type='hidden' id='one_block_delete_img_id_" + num_delete_img + "' name='deleteImg_[" + num_delete_img++ + "]' value='" + id + "' />";
        div.innerHTML += str;

        //document.getElementById("div_img_show_block_" + id).innerHTML = "<p>Удалено</p>";

        document.getElementById("div_img_hide_block_" + id).style.display = 'none';

        document.getElementById("div_img_reset_block_" + id).style.display = 'block';
    }

    function reset_img(but) {
        var id = but.id.split("_")[1];
        var cur_num = 0;
        var res = "";
        for (var i = 0; i < num_delete_img; ++i) {
            var del = document.getElementById('one_block_delete_img_id_' + i);
            if (del.value != id) {
                res += "<input type='hidden' id='one_block_delete_img_id_" + cur_num + "' name='deleteImg_[" + cur_num++ + "]' value='" + del.value + "' />";
            }

        }
        num_delete_img = cur_num;
        var div = document.getElementById("div_delete_img_id");
        div.innerHTML = res;
        document.getElementById("div_img_hide_block_" + id).style.display = 'block';

        document.getElementById("div_img_reset_block_" + id).style.display = 'none';
        

    }


    function EditPhysFunc() {

        data_descr_search.function_trigger = function () {

            
                var data = new FormData();
                let massFiles=document.getElementById('upLoadImagesId').files;

                $.each(massFiles, function (key, value) {
                    data.append('uploadImage', value);
                });

            //var divForm = document.getElementById('physEditFormDescrRecDiv');
            //var divFormNewInner = '';//'<H1>Отправляем</H1>';
            for (key in data_descr_search) {
                if (key != 'function_trigger' && key != 'search') {
                    if (key == 'stateBegin' || key == 'stateEnd')
                        data.append('Obj.'+key + 'Id',data_descr_search[key]);//Obj.
                    else if(key == 'CountInput'||key =='ChangedObject'){
                        data.append('Obj.'+key ,data_descr_search[key] );//Obj.
                        //document.getElementById('');
                    }
                        else
                        data.append(key ,data_descr_search[key] );

                    if (data_descr_search[key] == 'undefined' || data_descr_search[key] == undefined) {
                        if (key.indexOf('state')>=0)
                            alert('Не выбрано состояние');
                        else
                            alert('Что то пошло не так');
                        return;
                    }
                }
            }
            

            //divForm.innerHTML = divFormNewInner;
            ////var divImgForm = document.getElementById('physEditFormIMGDiv');
            ////divImgForm.style.display = 'none';
            //document.getElementById('FormPhysEdit').submit();
            data.append('obj.Name', document.getElementById('Name').value);
            data.append('obj.Text', document.getElementById('Text').value);
            data.append('obj.TextInp', document.getElementById('TextInp').value);
            data.append('obj.TextOut', document.getElementById('TextOut').value);
            data.append('obj.TextObj', document.getElementById('TextObj').value);
            data.append('obj.TextApp', document.getElementById('TextApp').value);
            data.append('obj.TextLit', document.getElementById('TextLit').value);
            data.append('obj.IDFE', document.getElementById('IDFE').value);

            for(let i=0;i<num_delete_img;++i){
                
                data.append('deleteImg_', document.getElementById('one_block_delete_img_id_'+i).value);
            }
            



            $.ajax({
                url: '/Physic/Edit',
                type: 'POST',
                data: data,
                cache: false,
                dataType: 'json',
                processData: false, // Не обрабатываем файлы (Don't process the files)
                contentType: false, // Так jQuery скажет серверу что это строковой запрос
                //success: function (respond, textStatus, jqXHR) {

                //    alert("Запись создана успешно, ссылка- " + respond);
                //},
                complete: function (respond, textStatus, jqXHR) {
                    if (respond.status==200)
                        alert("Запись изменена успешно, ссылка- " + window.location.origin + respond.responseText);
                }
            });
        };
        Go_next_step();
    }


</script>




<h2>Edit</h2>
@Html.ActionLink("Вернуться к просмотру", "Details", "Physic", new { id = Model.Obj.IDFE }, new { })
@if(Model== null)
{
    <p>запись не найдена</p>
}
@Html.ValidationSummary()
@if (Model != null)
{

    <div>
        

        @Html.Action("DescriptionFormAll", "Actions", new
   {
       countInput= Model.Obj.CountInput,
       changedObject= Model.Obj.ChangedObject,
       stateIdBegin= Model.Obj.StateBeginId,
       stateIdEnd = Model.Obj.StateEndId,
       objFormsBegin = Model.FormObjectBegin,
       objFormsEnd = Model.FormObjectEnd,
       inp = Model.FormsInput,
       outp = Model.FormsOutput
   })



        @*@using (Html.BeginForm("Edit", "Physic", FormMethod.Post, new {id= "FormPhysEdit", enctype = "multipart/form-data" }))
        {

            
            <div id="physEditFormDescrRecDiv">

            </div>*@
           

            
            @Html.Action("FeTextInput", "Helpers", new { obj = Model.Obj })
           

            <div id="div_delete_img_id">

            </div>


            <div id="physEditFormIMGDiv">
                <input class="btn btn-default" type="file" id="upLoadImagesId" multiple name="uploadImage" />
            </div>
                @*<input class="btn btn-default" type="submit" value="отправить" />*@
                @*}*@
                <input class="btn btn-default" onclick="EditPhysFunc()" value="отправить" />
                <div class="block_images">
                    <div class="inline">
                        @foreach (var i in Model.Obj.Images)
                        {
                            @*<div class="div_img_record_show_block div_inline_block" id="div_img_show_block_@i.Id">
                                    <div class="one_effect_img" style="background:url( data:image/jpeg;base64,@Convert.ToBase64String(i.Data)) no-repeat;background-size: cover;">
                                    </div>
                                    <button id="buttonDeleteId_@i.Id" onclick="delete_img(this)">Удалить</button>
                                </div>*@
                            <div class="div_img_record_show_block div_inline_block" id="div_img_show_block_@i.Id">
                                <div id="div_img_hide_block_@i.Id">
                                    <div class="details_one_image">
                                        @Html.Action("ImageLink", "Helpers", new { a = i })

                                    </div>
                                    <div class="edit_button_image_action">
                                        <button id="buttonDeleteId_@i.Id" class="btn btn-default" onclick="delete_img(this)">Удалить</button>
                                    </div>
                                </div>
                                <div class="edit_button_image_action" id="div_img_reset_block_@i.Id" style="display:none;">
                                    <button id="buttonResetId_@i.Id" class="btn btn-default" onclick="reset_img(this)">Восстановить</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>





        }



